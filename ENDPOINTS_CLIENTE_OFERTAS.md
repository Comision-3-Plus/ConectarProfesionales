# Endpoints de Cliente - Gesti√≥n de Ofertas

## ‚úÖ Implementaci√≥n Completada

### Endpoints Creados

#### 1. Listar Ofertas Recibidas
**GET** `/api/v1/cliente/ofertas`

**Autenticaci√≥n**: JWT (cualquier usuario autenticado)

**Response** (200):
```json
[
  {
    "id": "uuid1",
    "profesional_id": "uuid-prof",
    "cliente_id": "uuid-cliente",
    "chat_id": "chat-123",
    "descripcion": "Instalaci√≥n de aire acondicionado...",
    "precio_final": 1500.00,
    "estado": "OFERTADO",
    "fecha_creacion": "2025-10-19T14:30:00",
    "fecha_actualizacion": "2025-10-19T14:30:00"
  },
  {
    "id": "uuid2",
    "profesional_id": "uuid-prof2",
    "cliente_id": "uuid-cliente",
    "chat_id": "chat-124",
    "descripcion": "Reparaci√≥n de plomer√≠a...",
    "precio_final": 800.00,
    "estado": "ACEPTADO",
    "fecha_creacion": "2025-10-18T10:00:00",
    "fecha_actualizacion": "2025-10-18T11:30:00"
  }
]
```

---

#### 2. ‚≠ê Aceptar Oferta (DISPARADOR M√ìDULO 5)
**POST** `/api/v1/cliente/ofertas/{oferta_id}/accept`

**Autenticaci√≥n**: JWT (cualquier usuario autenticado)

**Path Parameters**:
- `oferta_id`: UUID de la oferta a aceptar

**Response** (200):
```json
{
  "id": "uuid-oferta",
  "profesional_id": "uuid-profesional",
  "cliente_id": "uuid-cliente",
  "chat_id": "firestore-chat-id",
  "descripcion": "Instalaci√≥n de aire acondicionado split 3000 frigor√≠as",
  "precio_final": 1500.00,
  "estado": "ACEPTADO",
  "fecha_creacion": "2025-10-19T14:30:00",
  "fecha_actualizacion": "2025-10-19T15:45:00"
}
```

**‚ö†Ô∏è ESTE ES EL DISPARADOR DEL M√ìDULO 5 (Pagos)**

La respuesta contiene:
- ‚úÖ `id`: UUID de la oferta (para trackear el pago)
- ‚úÖ `precio_final`: Monto exacto a pagar
- ‚úÖ `descripcion`: Descripci√≥n del servicio contratado
- ‚úÖ `profesional_id`: ID del profesional que recibir√° el pago
- ‚úÖ `estado`: "ACEPTADO" (confirmaci√≥n de aceptaci√≥n)

**Validaciones**:
- ‚úÖ La oferta debe existir
- ‚úÖ La oferta debe pertenecer al cliente actual
- ‚úÖ La oferta debe estar en estado "OFERTADO"
- ‚ùå Error 404 si no existe
- ‚ùå Error 403 si no pertenece al cliente
- ‚ùå Error 400 si ya fue aceptada/rechazada

**Efectos Secundarios**:
1. Cambia `oferta.estado` a `"ACEPTADO"` en Postgres
2. Env√≠a mensaje informativo al chat de Firestore:
   ```json
   {
     "type": "info",
     "text": "‚úÖ Oferta aceptada: $1500.00",
     "senderId": "cliente-uuid",
     "createdAt": serverTimestamp()
   }
   ```

---

#### 3. Rechazar Oferta
**POST** `/api/v1/cliente/ofertas/{oferta_id}/reject`

**Autenticaci√≥n**: JWT (cualquier usuario autenticado)

**Path Parameters**:
- `oferta_id`: UUID de la oferta a rechazar

**Response** (200):
```json
{
  "id": "uuid-oferta",
  "profesional_id": "uuid-profesional",
  "cliente_id": "uuid-cliente",
  "chat_id": "firestore-chat-id",
  "descripcion": "Instalaci√≥n de aire acondicionado split 3000 frigor√≠as",
  "precio_final": 1500.00,
  "estado": "RECHAZADO",
  "fecha_creacion": "2025-10-19T14:30:00",
  "fecha_actualizacion": "2025-10-19T15:50:00"
}
```

**Validaciones**:
- ‚úÖ La oferta debe existir
- ‚úÖ La oferta debe pertenecer al cliente actual
- ‚úÖ La oferta debe estar en estado "OFERTADO"
- ‚ùå Error 404 si no existe
- ‚ùå Error 403 si no pertenece al cliente
- ‚ùå Error 400 si ya fue aceptada/rechazada

**Efectos Secundarios**:
1. Cambia `oferta.estado` a `"RECHAZADO"` en Postgres
2. Env√≠a mensaje informativo al chat de Firestore:
   ```json
   {
     "type": "info",
     "text": "‚ùå La oferta fue rechazada",
     "senderId": "cliente-uuid",
     "createdAt": serverTimestamp()
   }
   ```

---

#### 4. Obtener Detalle de Oferta
**GET** `/api/v1/cliente/ofertas/{oferta_id}`

**Autenticaci√≥n**: JWT (cualquier usuario autenticado)

**Path Parameters**:
- `oferta_id`: UUID de la oferta

**Response** (200):
```json
{
  "id": "uuid-oferta",
  "profesional_id": "uuid-profesional",
  "cliente_id": "uuid-cliente",
  "chat_id": "firestore-chat-id",
  "descripcion": "Instalaci√≥n de aire acondicionado split 3000 frigor√≠as, incluye materiales y mano de obra",
  "precio_final": 1500.00,
  "estado": "OFERTADO",
  "fecha_creacion": "2025-10-19T14:30:00",
  "fecha_actualizacion": "2025-10-19T14:30:00"
}
```

**Validaciones**:
- ‚úÖ La oferta debe existir
- ‚úÖ La oferta debe pertenecer al cliente actual
- ‚ùå Error 404 si no existe
- ‚ùå Error 403 si no pertenece al cliente

**Uso**: Para mostrar el detalle completo antes de aceptar/rechazar

---

## üîÑ Flujo Completo de Aceptaci√≥n

```
1. Cliente ve tarjeta de oferta en el chat
   ‚Üì
2. Cliente hace clic en "Aceptar"
   ‚Üì
3. Frontend: POST /api/v1/cliente/ofertas/{id}/accept
   ‚Üì
4. Backend:
   - Valida permisos ‚úÖ
   - Valida estado ‚úÖ
   - Cambia estado a ACEPTADO ‚úÖ
   - Guarda en Postgres ‚úÖ
   - Notifica en Firestore ‚úÖ
   ‚Üì
5. Backend retorna:
   {
     id: "uuid",
     precio_final: 1500.00,
     profesional_id: "uuid",
     descripcion: "...",
     estado: "ACEPTADO"
   }
   ‚Üì
6. Frontend recibe la respuesta
   ‚Üì
7. üöÄ TRIGGER M√ìDULO 5 (Pagos)
   Frontend usa los datos para iniciar MercadoPago:
   - Monto: response.precio_final
   - Descripci√≥n: response.descripcion
   - Metadata: response.id (para trackear)
```

---

## üîÑ Flujo Completo de Rechazo

```
1. Cliente ve tarjeta de oferta en el chat
   ‚Üì
2. Cliente hace clic en "Rechazar"
   ‚Üì
3. Frontend: POST /api/v1/cliente/ofertas/{id}/reject
   ‚Üì
4. Backend:
   - Valida permisos ‚úÖ
   - Valida estado ‚úÖ
   - Cambia estado a RECHAZADO ‚úÖ
   - Guarda en Postgres ‚úÖ
   - Notifica en Firestore: "‚ùå La oferta fue rechazada" ‚úÖ
   ‚Üì
5. Backend retorna oferta actualizada
   ‚Üì
6. Frontend:
   - Muestra mensaje de confirmaci√≥n
   - Actualiza UI de la tarjeta (estado: rechazada)
   - Listener de Firestore recibe mensaje informativo
   - Profesional ve en su chat: "‚ùå La oferta fue rechazada"
```

---

## üéØ Para el Frontend

### Componente: Tarjeta de Oferta

```jsx
function OfertaCard({ oferta }) {
  const [loading, setLoading] = useState(false);
  
  const handleAccept = async () => {
    setLoading(true);
    try {
      const response = await fetch(
        `/api/v1/cliente/ofertas/${oferta.oferta_id}/accept`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
          }
        }
      );
      
      const data = await response.json();
      
      if (response.ok) {
        // ‚úÖ OFERTA ACEPTADA
        console.log('Oferta aceptada:', data);
        
        // üöÄ INICIAR M√ìDULO 5 (Pagos)
        iniciarPagoMercadoPago({
          amount: data.precio_final,
          description: data.descripcion,
          ofertaId: data.id,
          profesionalId: data.profesional_id
        });
      } else {
        alert(data.detail || 'Error al aceptar la oferta');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error de conexi√≥n');
    } finally {
      setLoading(false);
    }
  };
  
  const handleReject = async () => {
    setLoading(true);
    try {
      const response = await fetch(
        `/api/v1/cliente/ofertas/${oferta.oferta_id}/reject`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
          }
        }
      );
      
      if (response.ok) {
        // ‚úÖ OFERTA RECHAZADA
        alert('Oferta rechazada');
        // La UI se actualizar√° autom√°ticamente con el listener de Firestore
      } else {
        const data = await response.json();
        alert(data.detail || 'Error al rechazar la oferta');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error de conexi√≥n');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="oferta-card">
      <h3>Nueva Oferta</h3>
      <p>{oferta.descripcion}</p>
      <h2>${oferta.precio_final}</h2>
      
      {oferta.estado === 'OFERTADO' && (
        <div className="actions">
          <button 
            onClick={handleAccept}
            disabled={loading}
            className="btn-accept"
          >
            ‚úÖ Aceptar
          </button>
          <button 
            onClick={handleReject}
            disabled={loading}
            className="btn-reject"
          >
            ‚ùå Rechazar
          </button>
        </div>
      )}
      
      {oferta.estado === 'ACEPTADO' && (
        <div className="badge-accepted">‚úÖ Aceptada</div>
      )}
      
      {oferta.estado === 'RECHAZADO' && (
        <div className="badge-rejected">‚ùå Rechazada</div>
      )}
    </div>
  );
}
```

---

## üîí Seguridad

### Validaciones Implementadas:
1. ‚úÖ **JWT requerido**: Solo usuarios autenticados
2. ‚úÖ **Ownership**: Solo el cliente due√±o puede aceptar/rechazar
3. ‚úÖ **Estado v√°lido**: Solo ofertas en estado OFERTADO
4. ‚úÖ **Existencia**: Validaci√≥n de que la oferta existe
5. ‚úÖ **Idempotencia**: No se puede aceptar/rechazar dos veces

### C√≥digos de Error:
- `401`: No autenticado
- `403`: No autorizado (oferta no pertenece al cliente)
- `404`: Oferta no encontrada
- `400`: Estado inv√°lido (ya aceptada/rechazada)

---

## üìä Estados de Oferta

```
OFERTADO ‚Üí (cliente acepta) ‚Üí ACEPTADO ‚Üí (pago exitoso) ‚Üí PAGADO
         ‚Üì
         (cliente rechaza) ‚Üí RECHAZADO (estado final)
```

---

## üöÄ Integraci√≥n con M√≥dulo 5 (Pagos)

### Datos Disponibles para MercadoPago:

Del endpoint `/accept`:
```json
{
  "id": "uuid-de-la-oferta",           // Para metadata/tracking
  "precio_final": 1500.00,              // Monto exacto
  "descripcion": "Servicio contratado", // Descripci√≥n
  "profesional_id": "uuid",             // Destinatario del pago
  "estado": "ACEPTADO"                  // Confirmaci√≥n
}
```

### Ejemplo de Integraci√≥n:
```javascript
async function iniciarPagoMercadoPago(ofertaData) {
  const preference = {
    items: [
      {
        title: ofertaData.descripcion,
        unit_price: ofertaData.precio_final,
        quantity: 1,
      }
    ],
    metadata: {
      oferta_id: ofertaData.ofertaId,
      profesional_id: ofertaData.profesionalId
    },
    back_urls: {
      success: `/pago/success?oferta_id=${ofertaData.ofertaId}`,
      failure: `/pago/failure`,
      pending: `/pago/pending`
    }
  };
  
  // Crear preferencia en MercadoPago
  const mp = new MercadoPago('PUBLIC_KEY');
  const checkout = mp.checkout({
    preference: preference
  });
  
  checkout.open();
}
```

---

## ‚úÖ Estado Actual

- ‚úÖ 4 endpoints creados
- ‚úÖ Validaciones completas
- ‚úÖ Notificaciones a Firestore
- ‚úÖ Logs informativos
- ‚úÖ Respuesta optimizada para M√≥dulo 5
- ‚úÖ API funcionando en `http://localhost:8004`

**¬°Sistema listo para integraci√≥n con el Frontend y M√≥dulo 5 (Pagos)!** üéØ
